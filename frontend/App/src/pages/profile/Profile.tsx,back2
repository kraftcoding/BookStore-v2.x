import { Box, Button, Container, TextField, Typography } from '@mui/material';
import { useNavigate } from 'react-router-dom';
import { useAppDispatch, useAppSelector } from '../../hooks/reduxHook';
import { IProfileInputs, logout, updateProfile } from '../../redux/reducers/authSlice';
import { useState } from 'react';
import { useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { yupResolver } from '@hookform/resolvers/yup';
import * as yup from 'yup';
import { PageContainer, UserInfoContainer } from './Profile.styles';


const loginSchema = yup.object({
  email: yup.string().email('Invalid email').required('Email is required'),
  password: yup.string().required('Password is required'),
});

const registerSchema = yup.object({
  name: yup.string().required('Name is required'),
  email: yup.string().email('Invalid email').required('Email is required'),
  password: yup
    .string()
    .min(8, 'Password must be at least 8 characters')
    .max(32, 'Password must not exceed 32 characters')
    .required('Password is required'),
});

const Profile = () => {
  const authInfo = useAppSelector((state) => state.auth);
  const dispatch = useAppDispatch();
  const navigate = useNavigate();

  const handleLogout = () => {
    dispatch(logout());
    navigate('/');
  };
  
  
  function handleChange(evt: { target: { value: any; name: any; }; }) {
    const value = evt.target.value; 
    setState({
      ...state,
      [evt.target.name]: value
    });
  }

  const [state, setState] = useState({
    password: authInfo.userInfo?.password,
    name: authInfo.userInfo?.name,
    email: authInfo.userInfo?.email
  });

 const {    
    handleSubmit,
    formState: { errors },
  } = useForm<IProfileInputs>({
    resolver: yupResolver(loginSchema),
  });

   useEffect(() => {
      if (!authInfo.loggedIn && !authInfo.error) {
        navigate('/login');
      }
    }, [
      authInfo.loggedIn,
      authInfo.error,
      authInfo.userInfo,
      dispatch,
      navigate,
    ]);

  const onSubmit = async (data: IProfileInputs) => {
      try {
        /*const credentials = {
          email: data.email,
          password: data.password,
        };*/
        await dispatch(updateProfile(data)).unwrap();
      } catch (e) {
        console.log(e);
      }
    };


/*
  const handleSubmitProfile = async () => {
     try {
        const profileData = {
          name: state.name,
          email: state.email,
          password: state.password,
        };        

        await dispatch(updateProfile(profileData)).unwrap();
      } catch (e) {
        console.log(e);
      }
  };*/

  return (
    <PageContainer>
      {!authInfo.loggedIn ? (
        <p>You are not logged in!</p>
      ) : (
      <UserInfoContainer>
       
              <Box
                sx={{
                  width: '100%',
                  display: 'flex',
                  flexDirection: 'column',
                  justifyContent: 'start',
                  alignItems: 'center',
                }}
              >
                <p>Welcome, you are logged in {authInfo.userInfo?.name}!</p>
                <Box>
                  <Typography variant="h5">User Information</Typography>
                </Box>            
               <form onSubmit={handleSubmit(onSubmit)}>
                <Box
                  maxWidth="lg"
                  key={authInfo.userInfo?.id}
                  sx={{
                    width: '100%',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'center',
                    mb: 1,
                    p: 1,
                  }}
                >
                  <TextField
                    id="name"
                    label="name"                  
                    sx={{ mb: 2 }}
                    type="text"                  
                    value={state.name}
                    name="name"
                    onChange={handleChange}                 
                  />
                  <TextField
                    id="email"
                    label="email"
                    sx={{ mb: 2 }}
                    type="email"
                    value={state.email}
                    name="email"
                    onChange={handleChange}
                  />
                  <TextField
                    id="password"
                    label="password"
                    sx={{ mb: 2 }}
                    type="password"
                    value={state.password}
                    name="password"
                    onChange={handleChange}
                    
                  />
                   <Button variant="contained" type="submit">Submit</Button>
                </Box>
              </form>
              <Box
                sx={{
                  width: '100%',
                  display: 'flex',
                  justifyContent: 'center',
                  mb: 2,
                }}
              >
                <Button
                  variant="contained"
                  color="warning"
                  onClick={handleLogout}
                >
                  log out
                </Button>
              </Box>
            </Box>
         
        
      </UserInfoContainer>
      )}
    </PageContainer>
  );
};

export default Profile;
